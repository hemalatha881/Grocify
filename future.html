<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Future Grocery Prediction</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {
    font-family:'Segoe UI', sans-serif;
    background: linear-gradient(to bottom, #e0f7fa, #ffffff);
}
.header {
    position: fixed;
    top:0; left:0; right:0;
    z-index:1000;
    background:#28a745;
    color:white;
    padding:15px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.header h4 { margin:0; }
.main { padding-top:120px; }
.total-cost {
    font-weight:bold;
    font-size:1.4rem;
    margin-bottom:20px;
    color:#00796b;
    text-align:center;
}
.card { border-radius:15px; margin-bottom:15px; box-shadow:0 4px 12px rgba(0,0,0,0.2); transition:0.3s; background:#ffffffaa; }
.card:hover { transform:scale(1.02); }
.card-body { display:flex; justify-content:space-between; align-items:center; font-weight:500; flex-direction: column; gap:5px; }
.times-added { font-size:0.9rem; color:#555; }
.btn-group { margin-bottom:20px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
</style>
</head>
<body>

<div class="header">
  <h4>Future Grocery Prediction</h4>
  <div>
    <button class="btn btn-light btn-sm me-2" onclick="window.location.href='index1.html'">üè† Home</button>
    <button class="btn btn-light btn-sm me-2" id="shareBtn">üì§ Share</button>
    <button class="btn btn-light btn-sm" id="pdfBtn">üìÑ PDF</button>
  </div>
</div>

<div class="main container">
  <div class="btn-group">
    <button class="btn btn-outline-success" onclick="setPredictionDays(7)">Next 7 Days</button>
    <button class="btn btn-outline-warning" onclick="setPredictionDays(10)">Next 10 Days</button>
    <button class="btn btn-outline-primary" onclick="setPredictionDays(30)">Next 30 Days</button>
  </div>

  <div class="total-cost" id="totalCost">Total Cost Required: ‚Çπ0.00</div>
  <div id="futureList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
</div>

<script>
const apiUrl = "http://localhost:8080/api/grocery";
let allItems = [];
let predictionDays = 7; // default

async function fetchAllItems(){
  try{
    const res = await fetch(apiUrl);
    if(!res.ok) throw new Error("Failed");
    allItems = await res.json();
    renderFutureList();
  }catch(err){
    console.error(err);
    alert("‚ùå Error fetching data from backend.");
  }
}

function setPredictionDays(days){
  predictionDays = days;
  renderFutureList();
}

function aggregateItems(items){
  const map = {};
  // filter items based on user entries (for demo, we keep all)
  items.forEach(i=>{
    if(map[i.name]){
      map[i.name].quantity += i.quantity;
      map[i.name].price += i.price;
      map[i.name].count += 1;
    }else{
      map[i.name]={...i, count:1};
    }
  });
  // simulate prediction: multiply by (days/7)
  Object.values(map).forEach(i=>{ 
    i.quantity = parseFloat((i.quantity * predictionDays/7).toFixed(2));
    i.price = parseFloat((i.price * predictionDays/7).toFixed(2));
  });
  return Object.values(map);
}

function renderFutureList(){
  const aggregated = aggregateItems(allItems);
  const listContainer = document.getElementById("futureList");
  const totalCostEl = document.getElementById("totalCost");
  let total = 0;

  if(aggregated.length===0){
    listContainer.innerHTML="<p class='text-center fw-bold'>No data available for prediction.</p>";
    totalCostEl.textContent="Total Cost Required: ‚Çπ0.00";
    return;
  }

  listContainer.innerHTML = aggregated.map(i=>{
    total += i.price;
    return `
      <div class="col">
        <div class="card">
          <div class="card-body">
            <div><strong>${i.name}</strong></div>
            <div>Quantity: ${i.quantity} ${i.unit}</div>
            <div>Price: ‚Çπ${i.price.toFixed(2)}</div>
            <div class="times-added">Added ${i.count} times</div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  totalCostEl.textContent = `Total Cost Required: ‚Çπ${total.toFixed(2)}`;
}

// PDF export
// PDF export
document.getElementById("pdfBtn").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(14);
  doc.text(`Predicted Grocery List (${predictionDays} Days)`, 14, 15);

  const items = document.querySelectorAll("#futureList .card-body");
  items.forEach((c,index)=>{
    const lines = [
      `${index+1}. ${c.children[0].textContent}`,
      `${c.children[1].textContent}`,
      `${c.children[2].textContent.replace('‚Çπ','Rs.')}`, // replace rupee
      `${c.children[3].textContent}`
    ];
    lines.forEach(line => {
      doc.text(line,14,y);
      y+=6;
    });
    y+=4;
    if(y>280){ doc.addPage(); y=20; }
  });

  doc.setFontSize(16);
  doc.setFont("helvetica","bold");
  doc.text(document.getElementById("totalCost").textContent.replace('‚Çπ','Rs.'),14,y+10);
  doc.save(`Grocery_Prediction_${predictionDays}days.pdf`);
});


// Share
document.getElementById("shareBtn").addEventListener("click", ()=>{
  const itemsText = Array.from(document.querySelectorAll("#futureList .card-body"))
    .map(c=>`${c.children[0].textContent} | ${c.children[1].textContent} | ${c.children[2].textContent} | ${c.children[3].textContent}`)
    .join('\n');
  
  // Open share options using navigator.share if supported
  if(navigator.share){
    navigator.share({
      title:`Grocery Prediction for Next ${predictionDays} Days`,
      text:`${itemsText}\nTotal Cost: ${document.getElementById("totalCost").textContent}`
    }).then(()=>console.log("Shared successfully"))
      .catch(err=>alert("Error sharing: "+err));
  }else{
    // fallback: copy to clipboard
    navigator.clipboard.writeText(`Grocery Prediction (${predictionDays} Days):\n${itemsText}\n${document.getElementById("totalCost").textContent}`)
      .then(()=>alert("‚úÖ Copied! You can now share.")) 
      .catch(()=>alert("Clipboard copy failed."));
  }
});

window.addEventListener("load", fetchAllItems);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
